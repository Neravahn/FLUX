<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FLUX - Engine</title>
  <style>
    @font-face {
      font-family: 'play-regular';
      src: url("{{ url_for('static', filename='fonts/Play-Regular.ttf') }}") format("truetype");
      font-weight: normal;
      font-style: normal;
    }

    body {
      background-color: #000;
      color: #dbe6ff;
      height: 100vh;
      margin: 0;
      font-family: 'play-regular', Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #chart-section {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      gap: 20px;
      padding: 20px;
      box-sizing: border-box;
    }

    #engine-canvas {
      border: 1px solid #f1f1f1;
      border-radius: 10px;
      background-color: #0d0d0d;
      flex-grow: 1;
      max-width: calc(100% - 340px);
    }

    #chart-controls {
      position: absolute;
      top: 30px;
      right: 340px;
      display: flex;
      gap: 10px;
    }

    #chart-controls button {
      background-color: #f1f1f1;
      color: black;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    #chart-controls button:hover {
      background-color: #0d0d0d;
      color: white;
    }

    #flux-panel {
      width: 300px;
      background-color: #0d0d0d;
      border: #f1f1f1 1px solid;
      border-radius: 10px;
      padding: 20px;
      height: fit-content;
    }

    #flux-panel h2 {
      margin: 0 0 20px 0;
      font-size: 1.5rem;
      font-weight: 500;
      color: #f1f1f1;
      text-align: center;
    }

    #flux-form .form-group {
      margin-bottom: 15px;
    }

    #flux-form label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: #f1f1f1;
    }

    #flux-form select,
    #flux-form input[type="date"],
    #flux-form textarea {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 3px solid #272727;
      background-color: #111;
      color: #f1f1f1;
      font-family: inherit;
      box-sizing: border-box;
    }

    #flux-form textarea {
      height: 80px;
      resize: vertical;
    }

    #flux-form button[type="submit"] {
      width: 100%;
      padding: 12px;
      background-color: transparent;
      color: white;
      border: #333 3px solid;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
      transition: background-color 0.2s;
    }

    #flux-form button[type="submit"]:hover {
      background-color: #f1f1f1;
      color: black;
    }

    .documentation-link {
      margin: 15px 0;
      font-size: 14px;
      color: #f1f1f1;
    }

    .documentation-link a {
      color: #f1f1f1;
      text-decoration: none;
    }

    .documentation-link a:hover {
      text-decoration: underline;
    }

    #engine-error {
      color: #ff4444;
      margin-top: 10px;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div id="chart-section">
    <canvas id="engine-canvas"></canvas>

    <div id="chart-controls">
      <button id="resetZoom">Reset Zoom</button>
      <button id="toggleGrid">Toggle Grid</button>
      <button id="downloadChart">Download</button>
    </div>

    <div id="flux-panel">
      <h2>FLUX ENGINE</h2>

      <form action="{{ url_for('engine') }}" method="POST" id="flux-form">
        <div class="form-group">
          <label for="ticker">Select Stock</label>
          <select id="ticker" name="ticker" required>
            <option value="">Select a stock...</option>
            <option value="AAPL">Apple (AAPL)</option>
            <option value="GOOGL">Alphabet (GOOGL)</option>
            <option value="MSFT">Microsoft (MSFT)</option>
            <option value="TSLA">Tesla (TSLA)</option>
            <option value="AMZN">Amazon (AMZN)</option>
          </select>
        </div>

        <div class="form-group">
          <label for="interval">Select Interval</label>
          <select id="interval" name="interval" required>
            <option value="">Select interval</option>
            <option value="1d">1 day</option>
            <option value="1h">1 hour</option>
            <option value="15m">15 minutes</option>
            <option value="5m">5 minutes</option>
            <option value="1wk">1 week</option>
            <option value="1mo">1 month</option>
          </select>
        </div>

        <div class="form-group">
          <label for="formula_1">Formula 1</label>
          <textarea id="formula_1" name="formula_1"
            placeholder="e.g., rolling_mean(close, 20) + sqrt(volume)"></textarea>
        </div>

        <div class="form-group">
          <label for="formula_2">Formula 2</label>
          <textarea id="formula_2" name="formula_2"
            placeholder="e.g., rolling_mean(close, 20) - sqrt(volume)"></textarea>
        </div>

        <div class="documentation-link">
          Don’t know how to create a formula?
          <a href="documentation.html" target="_blank">Click here</a>
        </div>

        <button type="submit">ANALYZE</button>
        <div id="engine-error"></div>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <script>
    const ctx = document.getElementById('engine-canvas').getContext('2d');
    let fluxChart;

    document.getElementById('flux-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const errorDiv = document.getElementById('engine-error');
      errorDiv.textContent = "";

      try {
        const response = await fetch('/engine', { method: 'POST', body: formData });
        if (!response.ok) throw new Error(`Network error: ${response.status}`);
        const data = await response.json();
        console.log("✅ Data received:", data);

        if (!data || !data.days || !data.close) throw new Error("Invalid data format");

        // Prepare OHLC + formulas
        const ohlc = data.open.map((o, i) => ({
          x: new Date(data.days[i]),
          o: o,
          h: data.high[i],
          l: data.low[i],
          c: data.close[i]
        }));

        const ma1 = data.values_1.map((v, i) => ({ x: new Date(data.days[i]), y: v }));
        const ma2 = data.values_2.map((v, i) => ({ x: new Date(data.days[i]), y: v }));

        if (fluxChart) fluxChart.destroy();

        fluxChart = new Chart(ctx, {
          type: 'candlestick',
          data: {
            datasets: [
              {
                label: 'Price',
                data: ohlc,
                color: {
                  up: '#00ff00',
                  down: '#ff3333',
                  unchanged: '#888888'
                }
              },
              {
                label: 'Formula 1',
                type: 'line',
                data: ma1,
                borderColor: '#00ffff',
                borderWidth: 1.5,
                pointRadius: 0,
                tension: 0.2
              },
              {
                label: 'Formula 2',
                type: 'line',
                data: ma2,
                borderColor: '#ff00ff',
                borderWidth: 1.5,
                pointRadius: 0,
                tension: 0.2
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: '#f1f1f1' } },
              tooltip: { mode: 'index', intersect: false }
            },
            scales: {
              x: {
                type: 'time',
                time: {
                  unit: 'day'
                },
                ticks: { color: '#f1f1f1' },
                grid: { color: '#333' }
              },
              y: {
                ticks: { color: '#f1f1f1' },
                grid: { color: '#333' }
              }
            }
          }
        });

      } catch (err) {
        console.error("❌ Error fetching/rendering data:", err);
        errorDiv.textContent = "Error fetching or rendering data: " + err.message;
      }
    });
  </script>
</body>
</html>
